<html>
<head></head>
<body>

<div id="pieChart"></div>
<div id="zoomPieChart"></div>

<script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.4.4/d3.min.js"></script>
<script src="js/lib/d3pie.min.js"></script>
<script>

// our data!
var BUDGET_CSV = 'data/fy-15-approved-budget.csv';

function capitalizeFirstLetter(string) {
  return string.charAt(0).toUpperCase() + string.slice(1);
}

var genericPieObject = {
	"header": {
		"title": {
			"text": "",
			"color": "#457bc3",
			"fontSize": 15,
			"font": "open sans"
		},
		"subtitle": {
			"text": " ",
			"color": "#a95d41",
			"fontSize": 12,
			"font": "open sans"
		},
		"location": "pie-center",
		"titleSubtitlePadding": 10
	},
	"footer": {
		"color": "#999999",
		"fontSize": 10,
		"font": "open sans",
		"location": "bottom-left"
	},
	"size": {
		"canvasHeight": 400,
		"canvasWidth": 600,
		"pieInnerRadius": "74%",
		"pieOuterRadius": "79%"
	},
	"data": {
		"sortOrder": "value-desc",
		"content": null
	},
	"labels": {
		"outer": {
			"pieDistance": 20
		},
		"inner": {
			"hideWhenLessThanPercentage": 1
		},
		"mainLabel": {
			"fontSize": 11
		},
		"percentage": {
			"color": "#ffffff",
			"decimalPlaces": 0
		},
		"value": {
			"color": "#adadad",
			"fontSize": 11
		},
		"lines": {
			"enabled": true
		},
		"truncation": {
			"enabled": true
		}
	},
	"effects": {
		"pullOutSegmentOnClick": {
			"effect": "linear",
			"speed": 100,
			"size": 5
		}
	},
	"misc": {
		"gradient": {
			"enabled": true,
			"percentage": 100
		}
	},
	callbacks: {
		onload: null,
		onMouseoverSegment: null,
		onMouseoutSegment: null,
		onClickSegment: null
	}
};


// mapping as a workaround 
// since d3pie seems not to care about the index of the content array
// s for start and e for end
// 
// numbering is relative to the segment index
var mapping = [
	// 0 Public safety
	{s: 6, e: 11},
	// 1 Public Infrastructure
	{s: 12, e: 15},
	// 2 Governmental Excellence & Effectiveness
	{s: 37, e: 48},
	// 3 Environmental Protection & Enhancement
	{s: 20, e: 26},
	// 4 Human & Family Development
	{s: 0, e: 5},
	// 5 Economic Vitality
	{s: 27, e: 31},
	// 6 Sustainable Community Development
	{s: 16, e: 19},
	// 7 Community & Cultural Engagement
	{s: 32, e: 36}
];

// aaaaaargh!!!! 
var childrenMapping = [
	[],
	[2, 1, 0],
	[],
	[],
	[],
	[],
	[],
	[]
];

// the pie visible on the screen
var currentPie;

// save the csv file into that js object
var data;

d3.csv(BUDGET_CSV, function(error, dataFromCsv) {

	data = dataFromCsv;

	// convert the strings to integers
  data.forEach(function(d) {
    d.total = +d.total;
  });

  var content = createInitialPieContent();
	var title = 'ABQ FY/15 BUDGET';

	// use the showSelected function to handle the click event
	var pieObject = createPieObject(title, content, showSelected);

	// create the main pie chart
	currentPie = new d3pie("pieChart", pieObject);
});


/**
 * createInitialPieContent return the main goals totals for the inital pie
 * @return object the content object to create the initial pie
 */
function createInitialPieContent() {
	// looks like the content array order doesn't match the segment indexation
	// wft d3pie?
	// so we use the mapping to work around this problem
	var content = [];
	for(var i = 0; i < 8; i++) {
		content.push({"value": data[mapping[i].e].total, "label": data[mapping[i].e].department});
	}
	return content;
}


/**
 * makePie create a new d3 pie object
 * @param  int index index of the segment. if -1 create the initial pie
 * @param  string elementId parent html element of the pie chart
 * @param  function callback for the click event
 * @return object return a new d3pie object
 */
function createPieObject(title, content, onClickCallback) {
	
	// deep clone the generic pie object
	var pieObject = JSON.parse(JSON.stringify(genericPieObject));
	pieObject.data.content = content;
	pieObject.header.title.text = title;
	pieObject.callbacks.onClickSegment = onClickCallback;

	return pieObject;
}


/**
 * createPieContent create the content object from the data
 * @param  int index the index of the segment we want to zoom on
 * @return object content the content
 */
function createZoomedPieContent(index) {
	var content = [];
	for(var i = mapping[index].s; i < mapping[index].e; i++) {
		content.push({"value": data[i].total, "label": data[i].department});
	}
	return content;
}


// previous: save the selected object
var previous = -1;

/**
 * showSelected called only on the main pie chart
 * 	handle one or two consecutive clicks on the same segment
 * @param  object selected selected object given auto by the d3pie API
 */
function showSelected(selected) {
	if(previous != -1 && selected.segment.id === previous.segment.id) {
		// console.log('two clicks');
		currentPie.destroy();
		zoomOnSegment(selected.index);
	} else {
		// console.log('one click');
		// save the selected object in previous
		previous = selected;
		showSegmentInfo(selected);
	}
}

/**
 * zoomOnSegment move the segment and show the details as a new pie chart
 * @param  int index the index of the selected segment
 */
function zoomOnSegment(index) {
	var content = createZoomedPieContent(index);
	var title = data[mapping[index].e].department;
	var pieObject = createPieObject(title, content, showSegmentInfo);
	currentPie = new d3pie('zoomPieChart', pieObject);
}

/**
 * showSegmentInfo show the information about the segment selected
 * @param  object selected the selected segment
 */
function showSegmentInfo(selected) {
	var initial = document.getElementById('pieChart').hasAttribute('d3pie');
	var pieChartPrefix = initial == true ? '#p0_' : '#p1_';

	var position = {
		x: d3.select(pieChartPrefix + 'subtitle').attr('x'),
		dy: '1.2em'
	};

	var index = selected.index;
	console.log(index);
	if(initial) { 
		index = mapping[index].e;
	} else {
		index = mapping[previous.index].s + index;
	}
	var textToShow = formatSegmentHtml(index, position);

	currentPie.updateProp('header.subtitle.text', textToShow);
}

/**
 * formatSegmentHtml 
 * @param  object selected the selected segment
 * @return string the selected segment related text
 */
function formatSegmentHtml(index, position) {
	if(typeof position === 'undefined') {
		console.error('position parameter is required');
		return;
	}

	// open the tspan
	var textToShow = '<tspan x="'+ position.x +'" dy="'+ position.dy +'">';
	var newLine = '</tspan><tspan x="'+ position.x +'" dy="'+ position.dy +'">';

	var wordIndex = data[index].wordIndex;
	if(wordIndex != -1) {
		splitResult = data[index].department.split(' ');
		textToShow += splitResult.slice(0, wordIndex).join(' ') 
		+ newLine + splitResult.slice(wordIndex, splitResult.length).join(' ');
	} else {
		textToShow += data[index].department;
	}

	textToShow += '</tspan>';

	return textToShow;
}

</script>

</body>
</html>
